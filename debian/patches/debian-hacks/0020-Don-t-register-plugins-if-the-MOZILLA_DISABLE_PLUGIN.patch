From d77f98479ebde0f15ecc15113f2c38bfd5eadd36 Mon Sep 17 00:00:00 2001
From: Mike Hommey <glandium@debian.org>
Date: Sat, 27 Sep 2008 17:17:39 +0200
Subject: [PATCH 20/35] Don't register plugins if the MOZILLA_DISABLE_PLUGINS environment variable is set

---
 modules/plugin/base/src/nsPluginHost.cpp |   25 +++++++++++++++++++++++++
 1 files changed, 25 insertions(+), 0 deletions(-)

diff --git a/modules/plugin/base/src/nsPluginHost.cpp b/modules/plugin/base/src/nsPluginHost.cpp
index aed4359..2e9bf08 100644
--- a/modules/plugin/base/src/nsPluginHost.cpp
+++ b/modules/plugin/base/src/nsPluginHost.cpp
@@ -235,6 +235,24 @@ PRBool gSkipPluginSafeCalls = PR_FALSE;
 nsIFile *nsPluginHost::sPluginTempDir;
 nsPluginHost *nsPluginHost::sInst;
 
+// Globally disable plugins
+static
+int pluginsdisabled()
+{
+  static int _disabled = -1;
+
+  if (_disabled >= 0)
+    return _disabled;
+
+  const char *env = PR_GetEnv("MOZILLA_DISABLE_PLUGINS");
+  if (env && env[0])
+    _disabled = 1;
+  else
+    _disabled = 0;
+
+  return _disabled;
+}
+
 // flat file reg funcs
 static
 PRBool ReadSectionHeader(nsPluginManifestLineReader& reader, const char *token)
@@ -5019,6 +5037,10 @@ nsresult nsPluginHost::FindPlugins(PRBool aCreatePluginList, PRBool * aPluginsCh
   // possible reset in subsequent ScanPluginsDirectory calls
   PRBool pluginschanged = PR_FALSE;
 
+  if (pluginsdisabled()) {
+    mPluginsLoaded = PR_TRUE;
+    return NS_OK;
+  }
   // Scan the app-defined list of plugin dirs.
   rv = dirService->Get(NS_APP_PLUGINS_DIR_LIST, NS_GET_IID(nsISimpleEnumerator), getter_AddRefs(dirList));
   if (NS_SUCCEEDED(rv)) {
@@ -5307,6 +5329,9 @@ nsPluginHost::WritePluginInfo()
 nsresult
 nsPluginHost::ReadPluginInfo()
 {
+  if (pluginsdisabled())
+    return NS_ERROR_FAILURE;
+
   nsresult rv;
 
   nsCOMPtr<nsIProperties> directoryService(do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID,&rv));
-- 
1.7.0.rc0.69.g2ee80

